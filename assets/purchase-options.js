class PurchaseOptions extends HTMLElement{constructor(){super(),this.selectors={product:"[data-main-product]",sellingPlanGroups:"[data-selling-plan-group-selector]",sellingPlans:"[data-selling-plan-selector]",sellingPlansWrapper:"[data-selling-plans-wrapper]"},this.productBase=!1,this.productSelector=this.closest(this.selectors.product).querySelector("product-selector"),this.productSelector||(this.productSelector=this.closest(this.selectors.product),this.productBase=!0),this.productForm=this.closest(this.selectors.product).querySelector("product-form")}connectedCallback(){this.setHandlers()}setHandlers(){this.querySelector(this.selectors.sellingPlanGroups).addEventListener("change",this.onSellingGroupChange.bind(this)),this.querySelectorAll(this.selectors.sellingPlans).forEach((t=>t.addEventListener("change",(t=>{t.target.closest("dropdown-input")?.classList?.remove("has-error"),this.updateProductSelector(t.target.value)}))))}onSellingGroupChange(t){if("one-time"==t.target.value){Array.from(this.querySelectorAll(this.selectors.sellingPlans)).map((t=>{t.value=""}));const t=this.querySelector(this.selectors.sellingPlansWrapper);t.style.maxHeight="0",t.classList.add("is-hidden");return this.closest(".product__purchase-options").querySelector(".product__purchase--info").classList.add("hidden"),void this.updateProductSelector()}const e=t.target.querySelector(`option[value="${t.target.value}"]`).dataset.id,r=this.querySelector(this.selectors.sellingPlansWrapper);r.querySelectorAll("[data-id]").forEach((t=>{t.classList.toggle("is-hidden",t.dataset.id!==e)})),r.style.maxHeight=`${r.scrollHeight}px`,r.classList.remove("is-hidden")}isOneTimePurchase(){return"one-time"===this.querySelector('[name="selling_plan_group"]').value}showError(){[...this.querySelectorAll(this.selectors.sellingPlansWrapper)].filter((t=>!t.classList.contains("is-hidden")))[0].querySelectorAll("dropdown-input").forEach((t=>t.classList.add("has-error")))}updateProductSelector(t){if(this.productBase)this.updateProductBase(t);else{if(this.productSelector.currentVariant||this.productSelector.updateVariant(),this.productSelector.updateURL(t),this.productSelector.renderProductInfo(),this.productSelector.currentVariant.available&&t)return this.productForm.setAttribute("data-has-selling-plan","true"),void this.productForm.toggleAddButton(!1,"");this.productForm.removeAttribute("data-has-selling-plan",!0),this.productForm.toggleAddButton(!1,"")}}updateProductBase(t){const e=this.productSelector.getSelectedVariant(this.productSelector);if(this.productSelector.updateSellingPlanURL(t,e.id),this.renderPurchaseInfo(e.id),e.available&&t)return this.productForm.setAttribute("data-has-selling-plan","true"),void this.productForm.toggleSubmitButton(!1,"");this.productForm.removeAttribute("data-has-selling-plan"),this.productForm.toggleSubmitButton(!1,"")}renderPurchaseInfo(t){const e=new URLSearchParams(window.location.search);e[e.has("variant")?"set":"append"]("variant",t),fetch(`${this.productSelector.dataset.url}?${e.toString()}`).then((t=>t.text())).then((t=>{const e=(new DOMParser).parseFromString(t,"text/html");[`#Product-Purchase-Options-${this.productSelector.dataset.section}`,`#ProductPurchaseInfo-${this.productSelector.dataset.section}`].map((t=>{const r=document.querySelector(t),s=e.querySelector(t);r&&s&&(r.classList.remove("hidden"),r.innerHTML=s.innerHTML)}))})).catch((t=>{console.error(t)}))}}customElements.define("purchase-options",PurchaseOptions)